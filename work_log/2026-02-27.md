# 2026-02-27

## 작업 내용

### 1. FastAPI 백엔드 + AWS Cognito 인증

`backend/main.py` 신규 작성.

- **Cognito OIDC 연동**: `authlib` 라이브러리로 `/login` → Cognito Hosted UI → `/authorize` 콜백 흐름 구현
- **세션 기반 인증**: `starlette SessionMiddleware` + `SECRET_KEY` 로 사용자 세션 유지
- `/me` 엔드포인트로 현재 로그인 사용자(sub, email) 확인
- `/logout` → Cognito Hosted UI 로그아웃으로 Cognito 세션까지 완전 종료

### 2. DynamoDB 클라우드 동기화

총 6개 테이블을 `boto3`으로 직접 다룸:

| 테이블 | PK | 설명 |
|---|---|---|
| `users` | `sub` | Cognito 최초 로그인 시 자동 등록 |
| `works` | `work_id` (`{sub}#{local_id}`) | 작품 메타 |
| `episodes` | `episode_id` (`{sub}#{local_id}`) | 에피소드/챕터 |
| `plots` | `plot_id` (`{sub}#{local_id}`) | 플롯 카드 메타 |
| `characters` | `character_id` (`{sub}#{local_id}`) | 등장인물 |
| `character_relations` | `relation_id` (`{sub}#{local_id}`) | 인물 관계 |
| `graph_layouts` | `layout_id` (`{sub}#{work_id}`) | 관계도 노드 위치 |

모든 PK는 `{Cognito sub}#{로컬 SQLite ID}` 형식으로 사용자별 네임스페이스 분리.

REST 엔드포인트 17개:
- Works CRUD (GET/POST/PUT/DELETE)
- Episodes CRUD (GET/POST/PUT/DELETE)
- Plots CRUD + Content (GET/POST/PUT/DELETE + PUT content / GET content)
- Characters CRUD (GET/POST/PUT/DELETE)
- Character Relations (GET/POST/DELETE)
- Graph Layout (GET/PUT)

### 3. S3 대본 콘텐츠 저장

버킷: `plot-editor-contents` (환경변수 `S3_BUCKET`)

- `PUT /plots/{id}/content` → `plots/{sub}/{plot_id}.json` 키로 S3에 저장
- DynamoDB plots 테이블에 `content_s3_key`, `updated_at` 동시 업데이트
- `GET /plots/{id}/content` → S3에서 TipTap JSON 반환 (없으면 `{}`)
- Plot 삭제 시 S3 오브젝트도 함께 삭제

### 4. 프론트엔드 클라우드 동기화 연동

**Editor (`src/components/Editor/index.tsx`)**
- 기존 SQLite auto-save(500ms debounce) 에 추가로 `PUT /plots/{id}/content` fire-and-forget 호출
- 로컬 저장 실패와 독립적으로 동작 (클라우드 오류가 편집을 막지 않음)

**GraphView (`src/components/GraphView/index.tsx`)**
- 마운트 시 `GET /graph-layout/{workId}` 로 저장된 노드 위치 복원
- 노드 드래그 완료(`onNodeDragStop`) 후 1초 debounce로 `PUT /graph-layout/{workId}` 저장
- 위치 데이터는 `{ [characterId]: { x, y } }` JSON 형태

### 5. 문서화

- `README.md` 신규 작성 (프로젝트 개요, 아키텍처, 실행 방법)
- `CLAUDE.md` Backend/Cloud Sync 섹션 추가

## 환경변수 (backend/.env, gitignore 처리)

```
SECRET_KEY=
COGNITO_REGION=
COGNITO_USER_POOL_ID=
COGNITO_CLIENT_ID=
COGNITO_CLIENT_SECRET=
COGNITO_DOMAIN=
REDIRECT_URI=http://localhost:8000/authorize
LOGOUT_URI=https://plot-editor.vercel.app/
FRONTEND_URL=https://plot-editor.vercel.app/
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
S3_BUCKET=plot-editor-contents
```

## 결정 사항

- 로컬 SQLite와 DynamoDB/S3를 동시에 유지하는 **이중 저장(dual-write)** 패턴 채택
  - 오프라인에서도 SQLite로 정상 동작, 온라인 시 클라우드에 자동 미러링
- DynamoDB PK를 `{sub}#{local_id}` 로 설계해 테이블 분리 없이 멀티유저 지원
- 대본 본문(TipTap JSON)은 DynamoDB 항목 크기 제한(400KB)을 피해 S3에 저장

## 이슈/메모

- `backend/.env`는 `.gitignore`의 `.env` 규칙으로 이미 제외됨
- DynamoDB `scan`은 소규모 데이터에 적합; 데이터 증가 시 GSI + `query` 전환 고려
- Tauri 앱에서 fetch는 `credentials: 'include'` 필수 (세션 쿠키 전송)
