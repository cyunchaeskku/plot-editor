# 2026-02-27

## 작업 내용

### 1. FastAPI 백엔드 + AWS Cognito 인증

`backend/main.py` 신규 작성.

- **Cognito OIDC 연동**: `authlib` 라이브러리로 `/login` → Cognito Hosted UI → `/authorize` 콜백 흐름 구현
- **세션 기반 인증**: `starlette SessionMiddleware` + `SECRET_KEY` 로 사용자 세션 유지
- `/me` 엔드포인트로 현재 로그인 사용자(sub, email) 확인
- `/logout` → Cognito Hosted UI 로그아웃으로 Cognito 세션까지 완전 종료

### 2. DynamoDB 클라우드 동기화

총 6개 테이블을 `boto3`으로 직접 다룸:

| 테이블 | PK | 설명 |
|---|---|---|
| `users` | `sub` | Cognito 최초 로그인 시 자동 등록 |
| `works` | `work_id` (`{sub}#{local_id}`) | 작품 메타 |
| `episodes` | `episode_id` (`{sub}#{local_id}`) | 에피소드/챕터 |
| `plots` | `plot_id` (`{sub}#{local_id}`) | 플롯 카드 메타 |
| `characters` | `character_id` (`{sub}#{local_id}`) | 등장인물 |
| `character_relations` | `relation_id` (`{sub}#{local_id}`) | 인물 관계 |
| `graph_layouts` | `layout_id` (`{sub}#{work_id}`) | 관계도 노드 위치 |

모든 PK는 `{Cognito sub}#{로컬 SQLite ID}` 형식으로 사용자별 네임스페이스 분리.

REST 엔드포인트 17개:
- Works CRUD (GET/POST/PUT/DELETE)
- Episodes CRUD (GET/POST/PUT/DELETE)
- Plots CRUD + Content (GET/POST/PUT/DELETE + PUT content / GET content)
- Characters CRUD (GET/POST/PUT/DELETE)
- Character Relations (GET/POST/DELETE)
- Graph Layout (GET/PUT)

### 3. S3 대본 콘텐츠 저장

버킷: `plot-editor-contents` (환경변수 `S3_BUCKET`)

- `PUT /plots/{id}/content` → `plots/{sub}/{plot_id}.json` 키로 S3에 저장
- DynamoDB plots 테이블에 `content_s3_key`, `updated_at` 동시 업데이트
- `GET /plots/{id}/content` → S3에서 TipTap JSON 반환 (없으면 `{}`)
- Plot 삭제 시 S3 오브젝트도 함께 삭제

### 4. AWS Lambda 서버리스 배포 (Serverless Framework)

- **서버리스 전환**: EC2 유지비용 절감을 위해 AWS Lambda + API Gateway 기반의 서버리스 아키텍처로 마이그레이션.
- **Serverless Framework v4**: `serverless.yml` 작성을 통해 배포 자동화.
- **Mangum 어댑터**: FastAPI 앱을 Lambda 핸들러로 변환하는 `mangum` 라이브러리 추가.
- **배포 주소**: `https://2d7yy4qlcb.execute-api.ap-northeast-2.amazonaws.com`

### 5. 프론트엔드 클라우드 동기화 연동

**Editor (`src/components/Editor/index.tsx`)**
- 기존 SQLite auto-save(500ms debounce) 에 추가로 `PUT /plots/{id}/content` fire-and-forget 호출
- 로컬 저장 실패와 독립적으로 동작 (클라우드 오류가 편집을 막지 않음)

**GraphView (`src/components/GraphView/index.tsx`)**
- 마운트 시 `GET /graph-layout/{workId}` 로 저장된 노드 위치 복원
- 노드 드래그 완료(`onNodeDragStop`) 후 1초 debounce로 `PUT /graph-layout/{workId}` 저장
- 위치 데이터는 `{ [characterId]: { x, y } }` JSON 형태

### 5. 문서화

- `README.md` 신규 작성 (프로젝트 개요, 아키텍처, 실행 방법)
- `CLAUDE.md` Backend/Cloud Sync 섹션 추가

## 환경변수 (backend/.env, gitignore 처리)

```
SECRET_KEY=
COGNITO_REGION=
COGNITO_USER_POOL_ID=
COGNITO_CLIENT_ID=
COGNITO_CLIENT_SECRET=
COGNITO_DOMAIN=
REDIRECT_URI=http://localhost:8000/authorize
LOGOUT_URI=https://plot-editor.vercel.app/
FRONTEND_URL=https://plot-editor.vercel.app/
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
S3_BUCKET=plot-editor-contents
```

## 결정 사항

- 로컬 SQLite와 DynamoDB/S3를 동시에 유지하는 **이중 저장(dual-write)** 패턴 채택
  - 오프라인에서도 SQLite로 정상 동작, 온라인 시 클라우드에 자동 미러링
- DynamoDB PK를 `{sub}#{local_id}` 로 설계해 테이블 분리 없이 멀티유저 지원
- 대본 본문(TipTap JSON)은 DynamoDB 항목 크기 제한(400KB)을 피해 S3에 저장

## 이슈/메모

- `backend/.env`는 `.gitignore`의 `.env` 규칙으로 이미 제외됨
- **Lambda 환경변수 예약어 충돌**: `.env`에 포함된 `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`가 Lambda의 예약어와 충돌하여 배포 실패 → `serverless-dotenv-plugin` 설정에서 해당 키들을 `exclude` 처리하여 해결.
- **IAM 권한**: Serverless 배포를 위해 `AdministratorAccess` 부여 필요.
- **Python 런타임**: 로컬 환경(3.13)과 맞춰 `serverless.yml`의 런타임을 `python3.13`으로 업데이트.
- DynamoDB `scan`은 소규모 데이터에 적합; 데이터 증가 시 GSI + `query` 전환 고려
- Tauri 앱에서 fetch는 `credentials: 'include'` 필수 (세션 쿠키 전송)

---

## UI 디자인 수정 및 고도화

변경 파일: `src/components/PlotPanel/index.tsx`, `src/components/Editor/ContinuousPlotEditor.tsx`, `src/components/NovelEditor/ChapterList.tsx`

### 핵심 문제 해결

**PlotCard 선택 배경 대비 부족 (CRITICAL)**
- `bg-[#AD1B02]/10`(연한 빨강) 위에 `text-[#E88D14]`(주황) P번호가 거의 안 보이는 문제
- `bg-[#3d0c04]` (진한 어두운 빨강)으로 교체 → 대비 약 5.2:1 (WCAG AA 통과)
- 선택/비선택 모두 `border-l-[3px]` 고정으로 레이아웃 흔들림 방지

### PlotPanel (`PlotPanel/index.tsx`)

| 항목 | Before | After |
|---|---|---|
| 선택 카드 배경 | `bg-[#AD1B02]/10` | `bg-[#3d0c04]` |
| 드래그 핸들 | `text-gray-600 hover:text-gray-400` | `text-[#5a3020] hover:text-[#a07050]` |
| 뷰모드 비활성 버튼 | `text-[#6a4030]` (대비 2.1:1) | `text-[#8a5535]` (대비 3.2:1) |
| 빈 상태 텍스트 | `text-[#6a4030]` | `text-[#8a5535]` |
| 헤더 추가 버튼 | `+` | `+ 추가` |

### ContinuousPlotEditor 툴바 테마 수정 (`Editor/ContinuousPlotEditor.tsx`)

툴바가 어두운 테마(`border-gray-800`, `hover:bg-gray-700`)였으나 우측 밝은 패널에 렌더링되는 문제 수정.

| 항목 | Before | After |
|---|---|---|
| 툴바 컨테이너 | `border-gray-800` | `border-gray-200 bg-white` |
| 씬 활성 버튼 | `bg-purple-700 text-purple-200` | `bg-purple-100 text-purple-700` |
| 대사 활성 버튼 | `bg-indigo-700 text-indigo-200` | `bg-indigo-100 text-indigo-700` |
| 나레이션/지문/단락 활성 | `bg-gray-600 text-gray-200` | `bg-gray-200 text-gray-800` |
| 비활성 버튼 전체 | `text-gray-500 hover:bg-gray-700` | `text-gray-600 hover:bg-gray-100` |
| 대사 캐릭터 드롭다운 | `bg-gray-800 border-gray-600` | `bg-white border-gray-200` |
| B/I/U/S 활성 | `bg-gray-600 text-white` | `bg-gray-200 text-gray-800` |
| 텍스트 서식 구분선 | `border-gray-700` | `border-gray-300` |
| 힌트 텍스트 | `text-gray-700` | `text-gray-400` |

### ChapterList emerald → 통합 팔레트 교체 (`NovelEditor/ChapterList.tsx`)

ChapterList가 단독으로 emerald 계열 강조색을 사용, 앱 팔레트(`#AD1B02`, `#E88D14`)로 통일.

| 항목 | Before | After |
|---|---|---|
| 활성 챕터 배경/테두리 | `bg-emerald-800/30 border-emerald-500` | `bg-[#3d0c04] border-[#AD1B02]` |
| 활성 챕터 텍스트 | `text-emerald-200` | `text-[#f0ddd0]` |
| 뷰모드 활성 버튼 | `bg-emerald-700 text-emerald-100` | `bg-[#AD1B02] text-[#f0ddd0]` |
| 추가 버튼 / 빈 상태 | `text-emerald-400 hover:text-emerald-300` | `text-[#E88D14] hover:text-[#F3BE26]` |
| 헤더 추가 버튼 | `+` | `+ 추가` |

### 결정 사항

- 색상 영역 이중 구조 확립: 좌측 패널(어두운 갈색 테마) / 우측 패널(밝은 흰색 테마)
- WCAG AA 기준(4.5:1) 준수를 목표로 대비 부족 색상 일괄 교체
- `npm run build` 타입 에러 없이 통과 확인
